<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ì‹ë‹¹ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    html, body { width: 100%; min-height: 100%; overflow-x: hidden; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: #e5e7eb; }

    .container {
      background: white;
      width: 100%;
      max-width: 440px;
      min-height: 100vh;
      overflow-x: hidden;
      margin: 0 auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.15);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 16px;
      text-align: center;
    }
    .header h1 { font-size: 22px; margin-bottom: 5px; }
    .header p { opacity: 0.9; font-size: 13px; }

    .content { padding: 16px; width: 100%; }

    .form-group { margin-bottom: 14px; width: 100%; }

    label { display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 14px; }
    label .optional { font-weight: normal; color: #9ca3af; font-size: 12px; margin-left: 4px; }

    input[type="text"], input[type="password"], input[type="email"],
    input[type="number"], input[type="date"], select {
      width: 100%;
      padding: 13px 14px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      -webkit-appearance: none;
      appearance: none;
      min-height: 50px;
      background-color: white;
    }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 35px;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      display: block;
      text-align: center;
      width: 100%;
      touch-action: manipulation;
      min-height: 50px;
      -webkit-appearance: none;
    }
    .btn:active { transform: scale(0.97); opacity: 0.85; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #f5f5f5; color: #333; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
      width: auto;
      display: inline-block;
      min-height: 38px;
    }

    .checkbox-group { display: flex; align-items: center; margin: 16px 0; }
    .checkbox-group input { margin-right: 10px; width: 22px; height: 22px; cursor: pointer; flex-shrink: 0; }
    .checkbox-group label { margin-bottom: 0; font-weight: normal; font-size: 15px; cursor: pointer; }

    .link { color: #667eea; text-decoration: none; font-size: 16px; cursor: pointer; padding: 10px; display: inline-block; }
    .link:hover { text-decoration: underline; }

    .text-center { text-align: center; }
    .mt-20 { margin-top: 20px; }
    .hidden { display: none !important; }

    .alert {
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 15px;
      word-break: break-word;
      line-height: 1.5;
    }
    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
    .alert-error   { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
    .alert-info    { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }

    .user-info {
      background: #f9fafb;
      padding: 12px 14px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .user-info-text { font-size: 15px; color: #374151; flex: 1; min-width: 0; word-break: break-all; }
    .user-info-text strong { color: #111827; }

    .btn-logout { padding: 10px 16px; font-size: 14px; width: auto; display: inline-block; min-height: 44px; white-space: nowrap; }

    .card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      width: 100%;
    }
    .card h3 { margin-bottom: 12px; color: #111827; font-size: 17px; }

    .table-wrap { width: 100%; margin-top: 8px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
      word-break: break-all;
      white-space: normal;
      vertical-align: top;
    }
    th { background: #f9fafb; font-weight: 600; color: #374151; white-space: nowrap; }
    tr:hover { background: #f9fafb; }

    .col-name  { width: 13%; }
    .col-dept  { width: 15%; }
    .col-menu  { width: 28%; }
    .col-price { width: 18%; }
    .col-date  { width: 26%; }

    .col-rname { width: 75%; }
    .col-act   { width: 25%; }

    .col-mname  { width: 40%; }
    .col-mprice { width: 22%; }
    .col-mact   { width: 38%; }

    .col-uid   { width: 17%; }
    .col-uname { width: 13%; }
    .col-udept { width: 17%; }
    .col-urole { width: 13%; }
    .col-urst  { width: 20%; }
    .col-udel  { width: 20%; }

    .col-dname { width: 75%; }
    .col-ddel  { width: 25%; }

    .total-amount {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 10px;
      margin-top: 14px;
      text-align: center;
    }
    .total-amount h2 { font-size: 22px; margin-bottom: 5px; }
    .total-amount p { opacity: 0.9; font-size: 14px; }

    .btn-group { display: flex; flex-direction: column; gap: 8px; }
    .btn-group .btn { width: 100%; }

    .inline-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; width: 100%; }
    .inline-form .form-group { flex: 1; margin-bottom: 0; width: 100%; }
    .inline-form .btn { width: 100%; }

    .loading { text-align: center; padding: 30px 20px; color: #6b7280; }
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .period-selector { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; width: 100%; }
    .period-selector .form-group { flex: 1; margin-bottom: 0; width: 100%; }
    .period-selector .btn { width: 100%; }

    .empty-state { text-align: center; padding: 30px 16px; color: #6b7280; }
    .empty-state-icon { font-size: 44px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state p { font-size: 14px; line-height: 1.5; }

    .restaurant-buttons { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
    .restaurant-buttons .btn { width: 100%; font-size: 15px; }
    .restaurant-buttons .btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    }
    .restaurant-buttons .btn-all { background: #059669; color: white; }
    .restaurant-buttons .btn-all.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 12px rgba(16,185,129,0.4);
    }

    .admin-restaurant-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border-radius: 10px; padding: 14px 16px;
      margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
    }
    .admin-restaurant-banner .banner-icon { font-size: 28px; }
    .admin-restaurant-banner .banner-text { flex: 1; }
    .admin-restaurant-banner .banner-label { font-size: 12px; opacity: 0.85; margin-bottom: 2px; }
    .admin-restaurant-banner .banner-name { font-size: 18px; font-weight: 700; }

    .menu-edit-row { background: #eff6ff; border: 1.5px solid #bfdbfe; border-radius: 8px; padding: 10px; margin-top: 6px; }
    .menu-edit-row input { font-size: 15px; padding: 9px 12px; min-height: 42px; }
    .menu-edit-actions { display: flex; gap: 6px; margin-top: 8px; }
    .menu-edit-actions .btn { min-height: 38px; font-size: 13px; }

    .master-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; color: white; }
    .master-header-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .master-title { font-size: 12px; opacity: 0.8; margin-bottom: 2px; }
    .master-name { font-size: 16px; color: white; }
    .master-header .btn-logout {
      background: rgba(255,255,255,0.2); color: white;
      border: 1px solid rgba(255,255,255,0.4);
      width: auto; padding: 8px 16px; font-size: 14px; min-height: 40px;
    }

    .master-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; }
    .master-menu-btn {
      background: white; border: 2px solid #e5e7eb; border-radius: 14px;
      padding: 24px 12px; text-align: center; cursor: pointer; transition: all 0.2s;
      -webkit-appearance: none; touch-action: manipulation; width: 100%;
    }
    .master-menu-btn:active { transform: scale(0.96); border-color: #667eea; background: #f5f3ff; }
    .master-menu-icon { font-size: 36px; margin-bottom: 10px; line-height: 1; }
    .master-menu-label { font-size: 15px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
    .master-menu-desc { font-size: 12px; color: #9ca3af; }

    .master-page { width: 100%; }
    .page-header {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px; background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      position: sticky; top: 0; z-index: 20;
    }
    .back-btn {
      background: none; border: none; color: #667eea;
      font-size: 15px; font-weight: 600; cursor: pointer;
      padding: 6px 4px; -webkit-appearance: none; touch-action: manipulation; white-space: nowrap;
    }
    .back-btn:active { opacity: 0.6; }
    .page-title { font-size: 17px; font-weight: 700; color: #111827; margin: 0; }

    .master-page .card { margin: 12px 12px 0; }
    .master-page .card:last-child { margin-bottom: 12px; }

    .member-role-badge { display: inline-block; padding: 2px 6px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-master { background: #fef3c7; color: #92400e; }
    .badge-admin  { background: #dbeafe; color: #1e40af; }
    .badge-user   { background: #f3f4f6; color: #374151; }

    .price-display {
      padding: 13px 14px; border: 2px solid #e1e8ed; border-radius: 8px;
      font-size: 16px; min-height: 50px; background: #f9fafb; color: #9ca3af;
      display: flex; align-items: center;
    }
    .price-display.has-value { color: #111827; font-weight: 700; border-color: #667eea; background: white; }

    .summary-box {
      background: #f0fdf4;
      border: 1.5px solid #bbf7d0;
      border-radius: 10px;
      padding: 14px 16px;
      margin-top: 12px;
    }
    .summary-box h4 { font-size: 14px; color: #166534; margin-bottom: 8px; }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 0; font-size: 13px; color: #374151;
    }
    .summary-row.total {
      border-top: 1.5px solid #86efac; margin-top: 8px; padding-top: 10px;
      font-weight: 700; font-size: 15px; color: #065f46;
    }
    .summary-count { font-size: 11px; color: #6b7280; margin-left: 4px; }

    .pw-strength { margin-top: 6px; font-size: 12px; }
    .pw-strength-bar { height: 4px; border-radius: 2px; background: #e5e7eb; margin-bottom: 4px; }
    .pw-strength-fill { height: 100%; border-radius: 2px; transition: width 0.3s, background 0.3s; }
    .pw-weak   { color: #ef4444; }
    .pw-medium { color: #f59e0b; }
    .pw-strong { color: #10b981; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ½ï¸ ì‹ë‹¹ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
    <p>Kolon Restaurant Management System</p>
  </div>

  <div class="content">

    <!-- ===== ë¡œê·¸ì¸ ===== -->
    <div id="loginScreen">
      <div id="loginAlert"></div>
      <div class="form-group">
        <label for="loginUserId">ì•„ì´ë””</label>
        <input type="text" id="loginUserId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
      </div>
      <div class="form-group">
        <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password"
               onkeydown="if(event.key==='Enter') handleLogin();">
      </div>
      <button class="btn btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      <div class="checkbox-group">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ê¸°ì–µ</label>
      </div>
      <div class="text-center mt-20">
        <a class="link" onclick="showRegisterScreen()">íšŒì›ê°€ì…</a>
      </div>
    </div>

    <!-- ===== íšŒì›ê°€ì… ===== -->
    <div id="registerScreen" class="hidden">
      <div id="registerAlert"></div>
      <div class="inline-form">
        <div class="form-group" style="flex:2;">
          <label for="registerUserId">ì•„ì´ë””</label>
          <input type="text" id="registerUserId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
        </div>
        <button class="btn btn-secondary btn-small" onclick="checkDuplicateUserId()">ì¤‘ë³µí™•ì¸</button>
      </div>
      <div class="form-group">
        <label for="registerPassword">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="registerPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password"
               oninput="checkPasswordStrength(this.value)">
        <div class="pw-strength" id="pwStrengthWrap" style="display:none;">
          <div class="pw-strength-bar"><div class="pw-strength-fill" id="pwStrengthFill"></div></div>
          <span id="pwStrengthText"></span>
        </div>
      </div>
      <div class="form-group">
        <label for="registerName">ì´ë¦„</label>
        <input type="text" id="registerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
      </div>
      <div class="form-group">
        <label for="registerDepartment">ë¶€ì„œ</label>
        <select id="registerDepartment"><option value="">ë¡œë”© ì¤‘...</option></select>
      </div>
      <div class="form-group">
        <label for="registerEmail">ë©”ì¼ì£¼ì†Œ <span class="optional">(ì„ íƒ)</span></label>
        <input type="email" id="registerEmail" placeholder="example@kolon.com (ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤)" autocomplete="email">
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="handleRegister()">ê°€ì…í•˜ê¸°</button>
        <button class="btn btn-secondary" onclick="showLoginScreen()">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ===== ì¼ë°˜ ì‚¬ìš©ì ===== -->
    <div id="userScreen" class="hidden">
      <div class="user-info">
        <div class="user-info-text">
          <strong id="userNameDisplay"></strong>ë‹˜ (<span id="userDeptDisplay"></span>)
        </div>
        <button class="btn btn-secondary btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <div id="userAlert"></div>
      <div class="card">
        <h3>ì£¼ë¬¸í•˜ê¸°</h3>
        <div class="form-group">
          <label for="userRestaurantSelect">ì‹ë‹¹ ì„ íƒ</label>
          <select id="userRestaurantSelect" onchange="loadMenusForUser()">
            <option value="">ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        <div class="form-group">
          <label for="userMenuSelect">ë©”ë‰´ ì„ íƒ</label>
          <select id="userMenuSelect" onchange="onMenuSelected()">
            <option value="">ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        <div class="form-group">
          <label>ê¸ˆì•¡</label>
          <div id="userPriceDisplay" class="price-display">ë©”ë‰´ë¥¼ ì„ íƒí•˜ë©´ ê¸ˆì•¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
          <input type="hidden" id="userPrice" value="0">
        </div>
        <button class="btn btn-primary" onclick="handleUserOrder()">ì£¼ë¬¸ ë“±ë¡</button>
      </div>

      <div class="card">
        <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        <div id="userChangePwAlert"></div>
        <div class="form-group">
          <label for="userCurrentPw">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="userCurrentPw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group">
          <label for="userNewPw">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="userNewPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" oninput="checkPasswordStrength2(this.value)">
          <div class="pw-strength" id="pwStrengthWrap2" style="display:none;">
            <div class="pw-strength-bar"><div class="pw-strength-fill" id="pwStrengthFill2"></div></div>
            <span id="pwStrengthText2"></span>
          </div>
        </div>
        <div class="form-group">
          <label for="userNewPwConfirm">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input type="password" id="userNewPwConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <button class="btn btn-warning" onclick="handleChangePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      </div>
    </div>

    <!-- ===== ì‹ë‹¹ ê´€ë¦¬ì ===== -->
    <div id="adminScreen" class="hidden">
      <div class="user-info">
        <div class="user-info-text">
          <strong id="adminNameDisplay"></strong>ë‹˜ (<span id="adminDeptDisplay"></span>) - ì‹ë‹¹ ê´€ë¦¬ì
        </div>
        <button class="btn btn-secondary btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <div id="adminAlert"></div>

      <div id="adminRestaurantBanner" class="admin-restaurant-banner hidden">
        <div class="banner-icon">ğŸª</div>
        <div class="banner-text">
          <div class="banner-label">ë‹´ë‹¹ ì‹ë‹¹</div>
          <div class="banner-name" id="adminRestaurantName">-</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="margin-bottom:0;">ğŸ“… ë‹¹ì¼ ì£¼ë¬¸ í˜„í™©</h3>
          <button class="btn btn-success btn-small" onclick="refreshNow()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="todayOrdersContent">
          <div class="empty-state"><div class="empty-state-icon">ğŸ½ï¸</div><p>ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p></div>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“Š ê¸°ê°„ë³„ ì£¼ë¬¸ ì¡°íšŒ</h3>
        <div class="period-selector">
          <div class="form-group">
            <label for="adminStartDate">ì‹œì‘ì¼</label>
            <input type="date" id="adminStartDate">
          </div>
          <div class="form-group">
            <label for="adminEndDate">ì¢…ë£Œì¼</label>
            <input type="date" id="adminEndDate">
          </div>
          <button class="btn btn-primary" onclick="loadPeriodOrders()">ì¡°íšŒ</button>
        </div>
        <div id="periodOrdersContent">
          <div class="empty-state"><div class="empty-state-icon">ğŸ“†</div><p>ê¸°ê°„ì„ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p></div>
        </div>
      </div>
    </div>

    <!-- ===== ë§ˆìŠ¤í„° ê´€ë¦¬ì ===== -->
    <div id="masterScreen" class="hidden">
      <div class="master-header">
        <div class="master-header-top">
          <div>
            <div class="master-title">ë§ˆìŠ¤í„° ê´€ë¦¬ì</div>
            <div class="master-name"><strong id="masterNameDisplay"></strong>ë‹˜</div>
          </div>
          <button class="btn btn-secondary btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div id="masterHome">
        <div id="masterAlert"></div>
        <div class="master-menu-grid">
          <button class="master-menu-btn" onclick="showMasterPage('restaurant')">
            <div class="master-menu-icon">ğŸª</div>
            <div class="master-menu-label">ì‹ë‹¹ ê´€ë¦¬</div>
            <div class="master-menu-desc">ì‹ë‹¹ ì¶”ê°€ Â· ì‚­ì œ</div>
          </button>
          <button class="master-menu-btn" onclick="showMasterPage('menu')">
            <div class="master-menu-icon">ğŸ“‹</div>
            <div class="master-menu-label">ë©”ë‰´ ê´€ë¦¬</div>
            <div class="master-menu-desc">ë©”ë‰´ ì¶”ê°€ Â· ìˆ˜ì • Â· ì‚­ì œ</div>
          </button>
          <button class="master-menu-btn" onclick="showMasterPage('stats')">
            <div class="master-menu-icon">ğŸ“ˆ</div>
            <div class="master-menu-label">ì‹ë‹¹ë³„ í†µê³„</div>
            <div class="master-menu-desc">ê¸°ê°„ë³„ ì£¼ë¬¸ í†µê³„</div>
          </button>
          <button class="master-menu-btn" onclick="showMasterPage('members')">
            <div class="master-menu-icon">ğŸ‘¥</div>
            <div class="master-menu-label">íšŒì› ëª©ë¡</div>
            <div class="master-menu-desc">íšŒì› ì¶”ê°€ Â· ì‚­ì œ</div>
          </button>
          <button class="master-menu-btn" onclick="showMasterPage('departments')">
            <div class="master-menu-icon">ğŸ¢</div>
            <div class="master-menu-label">ë¶€ì„œ ê´€ë¦¬</div>
            <div class="master-menu-desc">ë¶€ì„œ ì¶”ê°€ Â· ì‚­ì œ</div>
          </button>
        </div>
      </div>

      <!-- ì‹ë‹¹ ê´€ë¦¬ -->
      <div id="masterPageRestaurant" class="master-page hidden">
        <div class="page-header">
          <button class="back-btn" onclick="showMasterHome()">â† ë’¤ë¡œ</button>
          <h2 class="page-title">ğŸª ì‹ë‹¹ ê´€ë¦¬</h2>
        </div>
        <div id="restaurantAlert"></div>
        <div class="card">
          <div class="inline-form">
            <div class="form-group">
              <label for="newRestaurantName">ì‹ë‹¹ ì´ë¦„</label>
              <input type="text" id="newRestaurantName" placeholder="ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button class="btn btn-success btn-small" onclick="handleAddRestaurant()">ì¶”ê°€</button>
          </div>
        </div>
        <div class="card">
          <div id="restaurantsContent"><div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div></div>
        </div>
      </div>

      <!-- ë©”ë‰´ ê´€ë¦¬ -->
      <div id="masterPageMenu" class="master-page hidden">
        <div class="page-header">
          <button class="back-btn" onclick="showMasterHome()">â† ë’¤ë¡œ</button>
          <h2 class="page-title">ğŸ“‹ ë©”ë‰´ ê´€ë¦¬</h2>
        </div>
        <div id="menuAlert"></div>
        <div class="card">
          <div class="form-group">
            <label for="menuRestaurantSelect">ì‹ë‹¹ ì„ íƒ</label>
            <select id="menuRestaurantSelect" onchange="loadMenusForMaster()">
              <option value="">ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>
          <div class="form-group">
            <label for="newMenuName">ë©”ë‰´ ì´ë¦„</label>
            <input type="text" id="newMenuName" placeholder="ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="form-group">
            <label for="newMenuPrice">ë©”ë‰´ ê¸ˆì•¡ (ì›)</label>
            <input type="number" id="newMenuPrice" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" min="0" inputmode="numeric">
          </div>
          <button class="btn btn-success" onclick="handleAddMenu()">ë©”ë‰´ ì¶”ê°€</button>
        </div>
        <div class="card">
          <div id="menusContent">
            <div class="empty-state"><div class="empty-state-icon">ğŸ”</div><p>ì‹ë‹¹ì„ ì„ íƒí•˜ë©´ ë©”ë‰´ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</p></div>
          </div>
        </div>
      </div>

      <!-- ì‹ë‹¹ë³„ í†µê³„ -->
      <div id="masterPageStats" class="master-page hidden">
        <div class="page-header">
          <button class="back-btn" onclick="showMasterHome()">â† ë’¤ë¡œ</button>
          <h2 class="page-title">ğŸ“ˆ ì‹ë‹¹ë³„ í†µê³„</h2>
        </div>
        <div id="statsAlert"></div>
        <div class="card">
          <div class="period-selector">
            <div class="form-group">
              <label for="masterStartDate">ì‹œì‘ì¼</label>
              <input type="date" id="masterStartDate">
            </div>
            <div class="form-group">
              <label for="masterEndDate">ì¢…ë£Œì¼</label>
              <input type="date" id="masterEndDate">
            </div>
          </div>
          <div class="form-group">
            <label for="statsDeptFilter">ë¶€ì„œ í•„í„° <span style="font-weight:normal;color:#9ca3af;">(ì„ íƒì‚¬í•­)</span></label>
            <select id="statsDeptFilter">
              <option value="">ì „ì²´ ë¶€ì„œ</option>
            </select>
          </div>
          <div id="restaurantButtonsContainer" style="margin-bottom:12px;">
            <div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>
          </div>
          <button class="btn btn-primary" onclick="loadRestaurantStats()">ì¡°íšŒ</button>
        </div>
        <div id="statsContent">
          <div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>ì‹ë‹¹ì„ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p></div>
        </div>
      </div>

      <!-- íšŒì› ëª©ë¡ -->
      <div id="masterPageMembers" class="master-page hidden">
        <div class="page-header">
          <button class="back-btn" onclick="showMasterHome()">â† ë’¤ë¡œ</button>
          <h2 class="page-title">ğŸ‘¥ íšŒì› ëª©ë¡</h2>
        </div>
        <div id="membersAlert"></div>
        <div class="card">
          <h3 style="margin-bottom:14px;">íšŒì› ì¶”ê°€</h3>
          <div class="form-group">
            <label for="newMemberUserId">ì•„ì´ë””</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="newMemberUserId" placeholder="ì•„ì´ë””" style="flex:1;">
              <button class="btn btn-secondary btn-small" onclick="checkMemberUserId()">ì¤‘ë³µí™•ì¸</button>
            </div>
          </div>
          <div class="form-group">
            <label for="newMemberPassword">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="newMemberPassword" placeholder="ë¹„ë°€ë²ˆí˜¸">
          </div>
          <div class="form-group">
            <label for="newMemberName">ì´ë¦„</label>
            <input type="text" id="newMemberName" placeholder="ì´ë¦„">
          </div>
          <div class="form-group">
            <label for="newMemberDept">ë¶€ì„œ</label>
            <select id="newMemberDept"><option value="">ë¡œë”© ì¤‘...</option></select>
          </div>
          <div class="form-group">
            <label for="newMemberEmail">ì´ë©”ì¼ <span class="optional">(ì„ íƒ)</span></label>
            <input type="email" id="newMemberEmail" placeholder="example@kolon.com">
          </div>
          <div class="form-group">
            <label for="newMemberRole">ì—­í• </label>
            <select id="newMemberRole" onchange="toggleRestaurantSelect()">
              <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
              <option value="admin">ì‹ë‹¹ ê´€ë¦¬ì</option>
              <option value="master">ë§ˆìŠ¤í„° ê´€ë¦¬ì</option>
            </select>
          </div>
          <div class="form-group hidden" id="memberRestaurantGroup">
            <label for="newMemberRestaurant">ë°°ì • ì‹ë‹¹</label>
            <select id="newMemberRestaurant"><option value="">ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
          </div>
          <button class="btn btn-primary" onclick="handleAddMember()">íšŒì› ì¶”ê°€</button>
        </div>
        <div class="card">
          <h3 style="margin-bottom:14px;">íšŒì› ëª©ë¡</h3>
          <div id="membersContent"><div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div></div>
        </div>
      </div>

      <!-- ë¶€ì„œ ê´€ë¦¬ -->
      <div id="masterPageDepartments" class="master-page hidden">
        <div class="page-header">
          <button class="back-btn" onclick="showMasterHome()">â† ë’¤ë¡œ</button>
          <h2 class="page-title">ğŸ¢ ë¶€ì„œ ê´€ë¦¬</h2>
        </div>
        <div id="deptAlert"></div>
        <div class="card">
          <div class="inline-form">
            <div class="form-group">
              <label for="newDeptName">ë¶€ì„œ ì´ë¦„</label>
              <input type="text" id="newDeptName" placeholder="ë¶€ì„œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button class="btn btn-success btn-small" onclick="handleAddDepartment()">ì¶”ê°€</button>
          </div>
        </div>
        <div class="card">
          <div id="deptsContent"><div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div></div>
        </div>
      </div>

    </div><!-- /masterScreen -->
  </div><!-- /content -->
</div><!-- /container -->

<script>
// ============================================
// â˜…â˜…â˜… GAS ì›¹ì•± URL ì„¤ì • (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤) â˜…â˜…â˜…
// ============================================
var GAS_URL = 'https://script.google.com/macros/s/AKfycbxUlAgKWRhyK2LtC7haPm06O040qojYbVzKisxvx5mDyB3JS9DRJ-9SnZLOf2n9MB_ZXg/exec';

// ============================================
// GAS API í˜¸ì¶œ í—¬í¼ (JSONP ë°©ì‹ â€” CORS ìš°íšŒ)
// ============================================
var _jsonpCallbackIndex = 0;

function gasCall(params) {
  return new Promise(function(resolve, reject) {
    var cbName = '_gasCallback_' + (++_jsonpCallbackIndex) + '_' + Date.now();
    params.callback = cbName;

    var url = GAS_URL + '?' + Object.keys(params).map(function(k) {
      return encodeURIComponent(k) + '=' + encodeURIComponent(params[k] !== undefined ? params[k] : '');
    }).join('&');

    var script = document.createElement('script');
    var timer = setTimeout(function() {
      cleanup();
      reject(new Error('timeout'));
    }, 15000);

    function cleanup() {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = function(data) {
      cleanup();
      resolve(data);
    };

    script.onerror = function() { cleanup(); reject(new Error('script error')); };
    script.src = url;
    document.head.appendChild(script);
  });
}

// POSTë„ JSONP GETìœ¼ë¡œ ì²˜ë¦¬ (GASëŠ” doGetì—ì„œ ëª¨ë‘ ì²˜ë¦¬)
function gasPost(params) {
  return gasCall(params);
}

// ============================================
// ì „ì—­ ìƒíƒœ
// ============================================
var currentUser = null;
var userIdChecked = false;
var memberIdChecked = false;
var selectedRestaurantId = 'all';
var adminRestaurantId = null;

// ============================================
// ìºì‹œ
// ============================================
var Cache = {
  restaurants: null,
  menus: {},
  members: null,
  departments: null,
  clear: function() { this.restaurants = null; this.menus = {}; this.members = null; this.departments = null; },
  clearRestaurants: function() { this.restaurants = null; this.menus = {}; },
  clearMenus: function(rId) { if (rId) delete this.menus[rId]; else this.menus = {}; },
  clearMembers: function() { this.members = null; },
  clearDepts: function() { this.departments = null; }
};

// ============================================
// ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬
// ============================================
function getPasswordStrength(pw) {
  if (!pw) return 0;
  var score = 0;
  if (pw.length >= 6) score++;
  if (pw.length >= 10) score++;
  if (/[a-zA-Z]/.test(pw)) score++;
  if (/[0-9]/.test(pw)) score++;
  if (/[^a-zA-Z0-9]/.test(pw)) score++;
  return score;
}

function renderStrength(score, fillId, textId, wrapId) {
  var wrap = document.getElementById(wrapId);
  var fill = document.getElementById(fillId);
  var text = document.getElementById(textId);
  if (!wrap || !fill || !text) return;
  wrap.style.display = 'block';
  var pct, color, label, cls;
  if (score <= 1)      { pct='20%'; color='#ef4444'; label='ë§¤ìš° ì•½í•¨'; cls='pw-weak'; }
  else if (score === 2){ pct='40%'; color='#f97316'; label='ì•½í•¨';     cls='pw-weak'; }
  else if (score === 3){ pct='60%'; color='#f59e0b'; label='ë³´í†µ';     cls='pw-medium'; }
  else if (score === 4){ pct='80%'; color='#84cc16'; label='ê°•í•¨';     cls='pw-strong'; }
  else                 { pct='100%';color='#10b981'; label='ë§¤ìš° ê°•í•¨'; cls='pw-strong'; }
  fill.style.width = pct;
  fill.style.background = color;
  text.textContent = label;
  text.className = cls;
}

function checkPasswordStrength(pw) {
  renderStrength(getPasswordStrength(pw), 'pwStrengthFill', 'pwStrengthText', 'pwStrengthWrap');
}
function checkPasswordStrength2(pw) {
  renderStrength(getPasswordStrength(pw), 'pwStrengthFill2', 'pwStrengthText2', 'pwStrengthWrap2');
}

// ============================================
// ì´ˆê¸°í™”
// ============================================
window.onload = function() {
  loadSavedCredentials();
  setDefaultDates();
};

function loadSavedCredentials() {
  try {
    if (localStorage.getItem('rememberMe') === 'true') {
      document.getElementById('loginUserId').value = localStorage.getItem('userId') || '';
      document.getElementById('loginPassword').value = localStorage.getItem('password') || '';
      document.getElementById('rememberMe').checked = true;
    }
  } catch(e) {}
}

function saveCredentials(userId, password, remember) {
  try {
    if (remember) {
      localStorage.setItem('rememberMe', 'true');
      localStorage.setItem('userId', userId);
      localStorage.setItem('password', password);
    } else {
      localStorage.removeItem('rememberMe');
      localStorage.removeItem('userId');
      localStorage.removeItem('password');
    }
  } catch(e) {}
}

function setDefaultDates() {
  var today = new Date().toISOString().split('T')[0];
  ['adminStartDate','adminEndDate','masterStartDate','masterEndDate'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = today;
  });
}

function preloadCache() {
  if (!Cache.restaurants) {
    gasCall({ action: 'getRestaurants' }).then(function(d) { Cache.restaurants = d; }).catch(function(){});
  }
}

// ============================================
// í™”ë©´ ì „í™˜
// ============================================
function hideAllScreens() {
  ['loginScreen','registerScreen','userScreen','adminScreen','masterScreen'].forEach(function(id) {
    document.getElementById(id).classList.add('hidden');
  });
  window.scrollTo(0, 0);
}

function showLoginScreen() {
  hideAllScreens();
  document.getElementById('loginScreen').classList.remove('hidden');
}

function showRegisterScreen() {
  hideAllScreens();
  document.getElementById('registerScreen').classList.remove('hidden');
  userIdChecked = false;
  loadDeptSelect('registerDepartment');
}

function showUserScreen() {
  hideAllScreens();
  document.getElementById('userScreen').classList.remove('hidden');
  document.getElementById('userNameDisplay').textContent = currentUser.name;
  document.getElementById('userDeptDisplay').textContent = currentUser.department;
  preloadCache();
  loadRestaurantsForUser();
}

function showAdminScreen() {
  hideAllScreens();
  document.getElementById('adminScreen').classList.remove('hidden');
  document.getElementById('adminNameDisplay').textContent = currentUser.name;
  document.getElementById('adminDeptDisplay').textContent = currentUser.department;

  adminRestaurantId = (currentUser.restaurantId || '').trim();

  if (!adminRestaurantId) {
    document.getElementById('adminRestaurantBanner').classList.remove('hidden');
    document.getElementById('adminRestaurantName').textContent = 'ë°°ì •ëœ ì‹ë‹¹ ì—†ìŒ';
    document.getElementById('todayOrdersContent').innerHTML =
      '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>ë§ˆìŠ¤í„° ê´€ë¦¬ìì—ê²Œ ì‹ë‹¹ ë°°ì •ì„ ìš”ì²­í•´ì£¼ì„¸ìš”</p></div>';
    setDefaultDates();
    return;
  }

  document.getElementById('adminRestaurantBanner').classList.remove('hidden');
  document.getElementById('adminRestaurantName').textContent = 'ë¡œë”© ì¤‘...';

  gasCall({ action: 'getAdminRestaurant', userId: currentUser.userId })
    .then(function(restaurant) {
      document.getElementById('adminRestaurantName').textContent = restaurant ? restaurant.name : 'ì‹ë‹¹ ì •ë³´ ì—†ìŒ';
    })
    .catch(function() {
      document.getElementById('adminRestaurantName').textContent = adminRestaurantId;
    });

  setDefaultDates();
  loadTodayOrders();
}

function showMasterScreen() {
  hideAllScreens();
  document.getElementById('masterScreen').classList.remove('hidden');
  document.getElementById('masterNameDisplay').textContent = currentUser.name;
  preloadCache();
  showMasterHome();
}

function showMasterHome() {
  document.getElementById('masterHome').classList.remove('hidden');
  document.querySelectorAll('.master-page').forEach(function(p) { p.classList.add('hidden'); });
  window.scrollTo(0, 0);
}

function showMasterPage(page) {
  document.getElementById('masterHome').classList.add('hidden');
  document.querySelectorAll('.master-page').forEach(function(p) { p.classList.add('hidden'); });

  if (page === 'restaurant') {
    document.getElementById('masterPageRestaurant').classList.remove('hidden');
    loadRestaurantsForMaster();
  } else if (page === 'menu') {
    document.getElementById('masterPageMenu').classList.remove('hidden');
    loadRestaurantSelectForMenu();
  } else if (page === 'stats') {
    document.getElementById('masterPageStats').classList.remove('hidden');
    setDefaultDates();
    loadRestaurantButtonsForStats();
    loadDeptSelectForStats();
  } else if (page === 'members') {
    document.getElementById('masterPageMembers').classList.remove('hidden');
    memberIdChecked = false;
    loadMembers();
    loadRestaurantSelectForMember();
    loadDeptSelect('newMemberDept');
  } else if (page === 'departments') {
    document.getElementById('masterPageDepartments').classList.remove('hidden');
    loadDepartmentsForMaster();
  }
  window.scrollTo(0, 0);
}

// ============================================
// ìƒˆë¡œê³ ì¹¨
// ============================================
function refreshNow() { loadTodayOrders(); }

// ============================================
// ì¸ì¦
// ============================================
function handleLogin() {
  var userId = document.getElementById('loginUserId').value.trim();
  var password = document.getElementById('loginPassword').value;
  var rememberMe = document.getElementById('rememberMe').checked;
  if (!userId || !password) { showAlert('loginAlert', 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  showLoading('loginAlert');

  gasCall({ action: 'login', userId: userId, password: password })
    .then(function(result) {
      if (result.success) {
        currentUser = result.user;
        saveCredentials(userId, password, rememberMe);
        if (currentUser.role === 'master') showMasterScreen();
        else if (currentUser.role === 'admin') showAdminScreen();
        else showUserScreen();
      } else {
        showAlert('loginAlert', result.message, 'error');
      }
    })
    .catch(function() { showAlert('loginAlert', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); });
}

function handleLogout() {
  currentUser = null; adminRestaurantId = null;
  Cache.clear(); showLoginScreen();
}

function checkDuplicateUserId() {
  var userId = document.getElementById('registerUserId').value.trim();
  if (!userId) { showAlert('registerAlert', 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

  gasCall({ action: 'checkUserId', userId: userId })
    .then(function(result) {
      showAlert('registerAlert', result.message, result.available ? 'success' : 'error');
      userIdChecked = result.available;
    })
    .catch(function() { showAlert('registerAlert', 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function handleRegister() {
  var userId     = document.getElementById('registerUserId').value.trim();
  var password   = document.getElementById('registerPassword').value;
  var name       = document.getElementById('registerName').value.trim();
  var department = document.getElementById('registerDepartment').value.trim();
  var email      = document.getElementById('registerEmail').value.trim();

  if (!userId || !password || !name || !department) {
    showAlert('registerAlert', 'ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„, ë¶€ì„œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤', 'error'); return;
  }
  if (!userIdChecked) { showAlert('registerAlert', 'ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showAlert('registerAlert', 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error'); return;
  }

  showLoading('registerAlert');
  gasPost({ action: 'registerUser', userId: userId, password: password, name: name, department: department, email: email })
    .then(function(result) {
      if (result.success) {
        showAlert('registerAlert', result.message, 'success');
        setTimeout(function() { showLoginScreen(); }, 2000);
      } else {
        showAlert('registerAlert', result.message, 'error');
      }
    })
    .catch(function() { showAlert('registerAlert', 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
// ============================================
function handleChangePassword() {
  var currentPw = document.getElementById('userCurrentPw').value;
  var newPw     = document.getElementById('userNewPw').value;
  var confirmPw = document.getElementById('userNewPwConfirm').value;

  if (!currentPw || !newPw || !confirmPw) {
    showAlert('userChangePwAlert', 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return;
  }
  if (newPw !== confirmPw) {
    showAlert('userChangePwAlert', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error'); return;
  }
  if (newPw.length < 4) {
    showAlert('userChangePwAlert', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error'); return;
  }

  showLoading('userChangePwAlert');
  gasPost({ action: 'changePassword', userId: currentUser.userId, currentPw: currentPw, newPw: newPw })
    .then(function(result) {
      if (result.success) {
        showAlert('userChangePwAlert', result.message, 'success');
        document.getElementById('userCurrentPw').value = '';
        document.getElementById('userNewPw').value = '';
        document.getElementById('userNewPwConfirm').value = '';
        document.getElementById('pwStrengthWrap2').style.display = 'none';
      } else {
        showAlert('userChangePwAlert', result.message, 'error');
      }
    })
    .catch(function() { showAlert('userChangePwAlert', 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ì¼ë°˜ ì‚¬ìš©ì - ì‹ë‹¹/ë©”ë‰´/ì£¼ë¬¸
// ============================================
function fillRestaurantSelect(selectId, restaurants) {
  var select = document.getElementById(selectId);
  select.innerHTML = '<option value="">ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”</option>';
  restaurants.forEach(function(r) {
    var opt = document.createElement('option');
    opt.value = r.id; opt.textContent = r.name; opt.dataset.name = r.name;
    select.appendChild(opt);
  });
}

function loadRestaurantsForUser() {
  if (Cache.restaurants) { fillRestaurantSelect('userRestaurantSelect', Cache.restaurants); return; }
  gasCall({ action: 'getRestaurants' })
    .then(function(d) { Cache.restaurants = d; fillRestaurantSelect('userRestaurantSelect', d); })
    .catch(function() { showAlert('userAlert', 'ì‹ë‹¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function fillMenuSelect(selectId, menus) {
  var s = document.getElementById(selectId);
  s.innerHTML = '<option value="">ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
  menus.forEach(function(menu) {
    var opt = document.createElement('option');
    opt.value = menu.id;
    opt.textContent = menu.name + (menu.price > 0 ? '  ' + menu.price.toLocaleString() + 'ì›' : '');
    opt.dataset.price = menu.price;
    opt.dataset.menuName = menu.name;
    s.appendChild(opt);
  });
}

function loadMenusForUser() {
  var rId = document.getElementById('userRestaurantSelect').value;
  document.getElementById('userMenuSelect').innerHTML = '<option value="">ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
  resetPriceDisplay();
  if (!rId) return;
  if (Cache.menus[rId]) { fillMenuSelect('userMenuSelect', Cache.menus[rId]); return; }
  gasCall({ action: 'getMenus', restaurantId: rId })
    .then(function(menus) { Cache.menus[rId] = menus; fillMenuSelect('userMenuSelect', menus); })
    .catch(function() { showAlert('userAlert', 'ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function onMenuSelected() {
  var s = document.getElementById('userMenuSelect');
  updatePriceDisplay(s.options[s.selectedIndex] ? Number(s.options[s.selectedIndex].dataset.price) || 0 : 0);
}

function updatePriceDisplay(price) {
  var d = document.getElementById('userPriceDisplay');
  document.getElementById('userPrice').value = price;
  if (price > 0) { d.textContent = price.toLocaleString() + 'ì›'; d.className = 'price-display has-value'; }
  else { d.textContent = 'ë©”ë‰´ë¥¼ ì„ íƒí•˜ë©´ ê¸ˆì•¡ì´ í‘œì‹œë©ë‹ˆë‹¤'; d.className = 'price-display'; }
}
function resetPriceDisplay() { updatePriceDisplay(0); }

function handleUserOrder() {
  var rSelect = document.getElementById('userRestaurantSelect');
  var mSelect = document.getElementById('userMenuSelect');
  var price = Number(document.getElementById('userPrice').value);
  var rId = rSelect.value;
  var rName = rSelect.options[rSelect.selectedIndex].dataset.name;
  var mOpt = mSelect.options[mSelect.selectedIndex];
  var menuName = mOpt ? (mOpt.dataset.menuName || mOpt.text) : '';
  if (!rId || !mSelect.value) { showAlert('userAlert', 'ì‹ë‹¹ê³¼ ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
  if (price <= 0) { showAlert('userAlert', 'ë©”ë‰´ ê¸ˆì•¡ì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”', 'error'); return; }
  showLoading('userAlert');

  gasPost({
    action: 'addOrder',
    userId: currentUser.userId,
    userName: currentUser.name,
    department: currentUser.department,
    restaurantId: rId,
    restaurantName: rName,
    menuName: menuName,
    price: price
  })
    .then(function(result) {
      if (result.success) showAlert('userAlert', 'ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      else showAlert('userAlert', 'ì£¼ë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    })
    .catch(function() { showAlert('userAlert', 'ì£¼ë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ì–´ë“œë¯¼ - ì£¼ë¬¸ ì¡°íšŒ
// ============================================
function loadTodayOrders() {
  if (!adminRestaurantId) {
    document.getElementById('todayOrdersContent').innerHTML = errorHtml('ë°°ì •ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  document.getElementById('todayOrdersContent').innerHTML = loadingHtml();
  gasCall({ action: 'getTodayOrders', restaurantId: adminRestaurantId })
    .then(function(result) {
      displayOrders('todayOrdersContent', result.orders, result.totalAmount, 'ë‹¹ì¼');
    })
    .catch(function() {
      document.getElementById('todayOrdersContent').innerHTML = errorHtml('ì£¼ë¬¸ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    });
}

function loadPeriodOrders() {
  if (!adminRestaurantId) { showAlert('adminAlert', 'ë°°ì •ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
  var startDate = document.getElementById('adminStartDate').value;
  var endDate   = document.getElementById('adminEndDate').value;
  if (!startDate || !endDate) { showAlert('adminAlert', 'ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
  document.getElementById('periodOrdersContent').innerHTML = loadingHtml();

  gasCall({ action: 'getOrdersByPeriod', restaurantId: adminRestaurantId, startDate: startDate, endDate: endDate })
    .then(function(result) {
      displayOrders('periodOrdersContent', result.orders, result.totalAmount, 'ê¸°ê°„');
    })
    .catch(function() {
      document.getElementById('periodOrdersContent').innerHTML = errorHtml('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    });
}

function displayOrders(containerId, orders, totalAmount, label) {
  var container = document.getElementById(containerId);
  if (!orders || orders.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>' + label + ' ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    return;
  }

  var menuMap = {};
  orders.forEach(function(o) {
    if (!menuMap[o.menuName]) menuMap[o.menuName] = { count: 0, total: 0 };
    menuMap[o.menuName].count++;
    menuMap[o.menuName].total += Number(o.price);
  });

  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-name"><col class="col-dept"><col class="col-menu"><col class="col-price"><col class="col-date"></colgroup>';
  html += '<thead><tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ë©”ë‰´</th><th>ê¸ˆì•¡</th><th>ì£¼ë¬¸ì¼ì‹œ</th></tr></thead><tbody>';
  orders.forEach(function(o) {
    var dt = new Date(o.orderDate);
    var dateStr = (dt.getMonth()+1) + '/' + dt.getDate() + ' ' +
                  String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
    html += '<tr><td>' + o.userName + '</td><td>' + o.department + '</td><td>' + o.menuName + '</td>';
    html += '<td>' + Number(o.price).toLocaleString() + 'ì›</td><td>' + dateStr + '</td></tr>';
  });
  html += '</tbody></table></div>';

  html += '<div class="summary-box"><h4>ğŸ“‹ ë©”ë‰´ë³„ ì§‘ê³„</h4>';
  Object.keys(menuMap).forEach(function(menuName) {
    var info = menuMap[menuName];
    html += '<div class="summary-row"><span>' + menuName + '<span class="summary-count">Ã—' + info.count + '</span></span>';
    html += '<span>' + info.total.toLocaleString() + 'ì›</span></div>';
  });
  html += '<div class="summary-row total"><span>í•©ê³„ <span class="summary-count">(' + orders.length + 'ê±´)</span></span>';
  html += '<span>' + totalAmount.toLocaleString() + 'ì›</span></div></div>';

  container.innerHTML = html;
}

// ============================================
// ë§ˆìŠ¤í„° - ì‹ë‹¹ ê´€ë¦¬
// ============================================
function renderRestaurantTable(restaurants) {
  var c = document.getElementById('restaurantsContent');
  if (!restaurants || restaurants.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸª</div><p>ë“±ë¡ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }
  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-rname"><col class="col-act"></colgroup>';
  html += '<thead><tr><th>ì‹ë‹¹ ì´ë¦„</th><th>ì‚­ì œ</th></tr></thead><tbody>';
  restaurants.forEach(function(r) {
    html += '<tr><td><strong>' + r.name + '</strong></td>';
    html += '<td><button class="btn btn-danger btn-small" onclick="deleteRestaurant(\'' + r.id + '\')">ì‚­ì œ</button></td></tr>';
  });
  html += '</tbody></table></div>';
  c.innerHTML = html;
}

function loadRestaurantsForMaster() {
  if (Cache.restaurants) { renderRestaurantTable(Cache.restaurants); return; }
  document.getElementById('restaurantsContent').innerHTML = loadingHtml();
  gasCall({ action: 'getRestaurants' })
    .then(function(d) { Cache.restaurants = d; renderRestaurantTable(d); })
    .catch(function() { document.getElementById('restaurantsContent').innerHTML = errorHtml('ì‹ë‹¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
}

function handleAddRestaurant() {
  var name = document.getElementById('newRestaurantName').value.trim();
  if (!name) { showAlert('restaurantAlert', 'ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  gasPost({ action: 'addRestaurant', name: name })
    .then(function(r) {
      if (r.success) {
        Cache.clearRestaurants();
        showAlert('restaurantAlert', 'ì‹ë‹¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        document.getElementById('newRestaurantName').value = '';
        loadRestaurantsForMaster();
      } else showAlert('restaurantAlert', 'ì‹ë‹¹ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    })
    .catch(function() { showAlert('restaurantAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function deleteRestaurant(rId) {
  if (!confirm('ì´ ì‹ë‹¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  gasPost({ action: 'deleteRestaurant', restaurantId: rId })
    .then(function(r) {
      if (r.success) { Cache.clearRestaurants(); showAlert('restaurantAlert', 'ì‹ë‹¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); loadRestaurantsForMaster(); }
      else showAlert('restaurantAlert', r.message, 'error');
    })
    .catch(function() { showAlert('restaurantAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ë§ˆìŠ¤í„° - ë©”ë‰´ ê´€ë¦¬
// ============================================
function loadRestaurantSelectForMenu() {
  if (Cache.restaurants) { fillRestaurantSelect('menuRestaurantSelect', Cache.restaurants); return; }
  gasCall({ action: 'getRestaurants' })
    .then(function(d) { Cache.restaurants = d; fillRestaurantSelect('menuRestaurantSelect', d); });
}

function renderMenuTable(menus) {
  var c = document.getElementById('menusContent');
  if (!menus || menus.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }
  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-mname"><col class="col-mprice"><col class="col-mact"></colgroup>';
  html += '<thead><tr><th>ë©”ë‰´ ì´ë¦„</th><th>ê¸ˆì•¡</th><th>ì•¡ì…˜</th></tr></thead><tbody>';
  menus.forEach(function(menu) {
    html += '<tr id="menu-row-' + menu.id + '">';
    html += '<td>' + menu.name + '</td>';
    html += '<td style="font-weight:600;color:#667eea;">' + (menu.price > 0 ? menu.price.toLocaleString() + 'ì›' : '-') + '</td>';
    html += '<td>';
    html += '<button class="btn btn-warning btn-small" style="margin-right:4px;margin-bottom:4px;" onclick="showMenuEditRow(\'' + menu.id + '\',\'' + escStr(menu.name) + '\',' + menu.price + ')">ìˆ˜ì •</button>';
    html += '<button class="btn btn-danger btn-small" onclick="deleteMenu(\'' + menu.id + '\')">ì‚­ì œ</button>';
    html += '</td></tr>';
    html += '<tr id="menu-edit-' + menu.id + '" class="hidden"><td colspan="3">';
    html += '<div class="menu-edit-row">';
    html += '<div class="form-group" style="margin-bottom:8px;"><label>ë©”ë‰´ ì´ë¦„</label>';
    html += '<input type="text" id="edit-name-' + menu.id + '" value="' + escStr(menu.name) + '"></div>';
    html += '<div class="form-group" style="margin-bottom:8px;"><label>ê¸ˆì•¡ (ì›)</label>';
    html += '<input type="number" id="edit-price-' + menu.id + '" value="' + menu.price + '" min="0" inputmode="numeric"></div>';
    html += '<div class="menu-edit-actions">';
    html += '<button class="btn btn-primary btn-small" onclick="handleUpdateMenu(\'' + menu.id + '\')">ì €ì¥</button>';
    html += '<button class="btn btn-secondary btn-small" onclick="hideMenuEditRow(\'' + menu.id + '\')">ì·¨ì†Œ</button>';
    html += '</div></div></td></tr>';
  });
  html += '</tbody></table></div>';
  c.innerHTML = html;
}

function escStr(s) { return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function showMenuEditRow(menuId) {
  document.querySelectorAll('[id^="menu-edit-"]').forEach(function(el) { el.classList.add('hidden'); });
  document.getElementById('menu-edit-' + menuId).classList.remove('hidden');
  document.getElementById('edit-name-' + menuId).focus();
}

function hideMenuEditRow(menuId) {
  document.getElementById('menu-edit-' + menuId).classList.add('hidden');
}

function handleUpdateMenu(menuId) {
  var newName  = document.getElementById('edit-name-' + menuId).value.trim();
  var newPrice = Number(document.getElementById('edit-price-' + menuId).value);
  if (!newName) { showAlert('menuAlert', 'ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (newPrice <= 0) { showAlert('menuAlert', 'ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  gasPost({ action: 'updateMenu', menuId: menuId, name: newName, price: newPrice })
    .then(function(r) {
      if (r.success) {
        Cache.clearMenus(document.getElementById('menuRestaurantSelect').value);
        showAlert('menuAlert', 'ë©”ë‰´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        loadMenusForMaster();
      } else showAlert('menuAlert', r.message || 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜', 'error');
    })
    .catch(function() { showAlert('menuAlert', 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function loadMenusForMaster() {
  var rId = document.getElementById('menuRestaurantSelect').value;
  if (!rId) {
    document.getElementById('menusContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><p>ì‹ë‹¹ì„ ì„ íƒí•˜ë©´ ë©”ë‰´ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</p></div>'; return;
  }
  if (Cache.menus[rId]) { renderMenuTable(Cache.menus[rId]); return; }
  document.getElementById('menusContent').innerHTML = loadingHtml();
  gasCall({ action: 'getMenus', restaurantId: rId })
    .then(function(menus) { Cache.menus[rId] = menus; renderMenuTable(menus); })
    .catch(function() { document.getElementById('menusContent').innerHTML = errorHtml('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
}

function handleAddMenu() {
  var rId       = document.getElementById('menuRestaurantSelect').value;
  var menuName  = document.getElementById('newMenuName').value.trim();
  var menuPrice = Number(document.getElementById('newMenuPrice').value) || 0;
  if (!rId)      { showAlert('menuAlert', 'ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
  if (!menuName) { showAlert('menuAlert', 'ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (menuPrice <= 0) { showAlert('menuAlert', 'ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  gasPost({ action: 'addMenu', restaurantId: rId, name: menuName, price: menuPrice })
    .then(function(r) {
      if (r.success) {
        Cache.clearMenus(rId);
        showAlert('menuAlert', 'ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        document.getElementById('newMenuName').value = '';
        document.getElementById('newMenuPrice').value = '';
        loadMenusForMaster();
      } else showAlert('menuAlert', 'ë©”ë‰´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    })
    .catch(function() { showAlert('menuAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function deleteMenu(menuId) {
  if (!confirm('ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  gasPost({ action: 'deleteMenu', menuId: menuId })
    .then(function(r) {
      if (r.success) { Cache.clearMenus(); showAlert('menuAlert', 'ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); loadMenusForMaster(); }
      else showAlert('menuAlert', r.message, 'error');
    })
    .catch(function() { showAlert('menuAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ë§ˆìŠ¤í„° - í†µê³„
// ============================================
function loadDeptSelectForStats() {
  var sel = document.getElementById('statsDeptFilter');
  if (!sel) return;
  if (Cache.departments) { fillDeptSelectForStats(Cache.departments); return; }
  gasCall({ action: 'getDepartments' })
    .then(function(depts) { Cache.departments = depts; fillDeptSelectForStats(depts); })
    .catch(function() {});
}

function fillDeptSelectForStats(depts) {
  var sel = document.getElementById('statsDeptFilter');
  if (!sel) return;
  sel.innerHTML = '<option value="">ì „ì²´ ë¶€ì„œ</option>';
  depts.forEach(function(d) {
    var opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    sel.appendChild(opt);
  });
}

function loadRestaurantButtonsForStats() {
  if (Cache.restaurants) { renderRestaurantButtons(Cache.restaurants); return; }
  document.getElementById('restaurantButtonsContainer').innerHTML = loadingHtml();
  gasCall({ action: 'getRestaurants' })
    .then(function(d) { Cache.restaurants = d; renderRestaurantButtons(d); });
}

function renderRestaurantButtons(restaurants) {
  var c = document.getElementById('restaurantButtonsContainer');
  if (!restaurants || restaurants.length === 0) { c.innerHTML = '<div class="empty-state"><p>ë“±ë¡ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }
  var html = '<div class="restaurant-buttons"><button class="btn btn-all active" onclick="selectRestaurantForStats(\'all\', this)">ğŸª ì „ì²´ ì¡°íšŒ</button>';
  restaurants.forEach(function(r) {
    html += '<button class="btn btn-secondary" onclick="selectRestaurantForStats(\'' + r.id + '\', this)">' + r.name + '</button>';
  });
  html += '</div>';
  c.innerHTML = html;
  selectedRestaurantId = 'all';
}

function selectRestaurantForStats(rId, btn) {
  document.querySelectorAll('.restaurant-buttons .btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  selectedRestaurantId = rId;
}

function loadRestaurantStats() {
  var startDate = document.getElementById('masterStartDate').value;
  var endDate   = document.getElementById('masterEndDate').value;
  if (!startDate || !endDate) { showAlert('statsAlert', 'ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
  document.getElementById('statsContent').innerHTML = loadingHtml();

  if (selectedRestaurantId === 'all') {
    gasCall({ action: 'getAllRestaurantOrders', startDate: startDate, endDate: endDate })
      .then(displayAllRestaurantStats)
      .catch(function() { document.getElementById('statsContent').innerHTML = errorHtml('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
  } else {
    gasCall({ action: 'getOrdersByPeriod', restaurantId: selectedRestaurantId, startDate: startDate, endDate: endDate })
      .then(displaySingleRestaurantStats)
      .catch(function() { document.getElementById('statsContent').innerHTML = errorHtml('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
  }
}

function buildOrderTable(orders) {
  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-name"><col class="col-dept"><col class="col-menu"><col class="col-price"><col class="col-date"></colgroup>';
  html += '<thead><tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ë©”ë‰´</th><th>ê¸ˆì•¡</th><th>ì£¼ë¬¸ì¼ì‹œ</th></tr></thead><tbody>';
  orders.forEach(function(o) {
    var dt = new Date(o.orderDate);
    var dateStr = (dt.getMonth()+1) + '/' + dt.getDate() + ' ' +
                  String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
    html += '<tr><td>' + o.userName + '</td><td>' + o.department + '</td><td>' + o.menuName + '</td>';
    html += '<td>' + Number(o.price).toLocaleString() + 'ì›</td><td>' + dateStr + '</td></tr>';
  });
  html += '</tbody></table></div>';
  return html;
}

function buildDeptSummaryBox(orders, totalAmount, deptFilter) {
  var menuMap = {};
  orders.forEach(function(o) {
    if (!menuMap[o.menuName]) menuMap[o.menuName] = { count: 0, total: 0 };
    menuMap[o.menuName].count++;
    menuMap[o.menuName].total += Number(o.price);
  });
  var html = '<div class="summary-box"><h4>ğŸ“‹ ë©”ë‰´ë³„ ì§‘ê³„' + (deptFilter ? ' Â· ' + deptFilter : '') + '</h4>';
  Object.keys(menuMap).forEach(function(menuName) {
    var info = menuMap[menuName];
    html += '<div class="summary-row"><span>' + menuName + '<span class="summary-count"> Ã—' + info.count + '</span></span><span>' + info.total.toLocaleString() + 'ì›</span></div>';
  });
  html += '<div class="summary-row total"><span>í•©ê³„ <span class="summary-count">(' + orders.length + 'ê±´)</span></span><span>' + totalAmount.toLocaleString() + 'ì›</span></div>';
  html += '</div>';

  if (!deptFilter) {
    var deptMap = {};
    orders.forEach(function(o) {
      if (!deptMap[o.department]) deptMap[o.department] = { count: 0, total: 0 };
      deptMap[o.department].count++;
      deptMap[o.department].total += Number(o.price);
    });
    var depts = Object.keys(deptMap);
    if (depts.length > 1) {
      html += '<div class="summary-box" style="background:#f0f9ff;border-color:#bae6fd;margin-top:8px;"><h4>ğŸ¢ ë¶€ì„œë³„ ì§‘ê³„</h4>';
      depts.sort().forEach(function(dept) {
        var info = deptMap[dept];
        html += '<div class="summary-row"><span>' + dept + '<span class="summary-count"> Ã—' + info.count + '</span></span><span>' + info.total.toLocaleString() + 'ì›</span></div>';
      });
      html += '</div>';
    }
  }
  return html;
}

function displayAllRestaurantStats(stats) {
  var c = document.getElementById('statsContent');
  var deptFilter = document.getElementById('statsDeptFilter').value;

  if (!stats || stats.length === 0) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>í•´ë‹¹ ê¸°ê°„ì— ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }

  var filtered = stats.map(function(stat) {
    var filteredOrders = deptFilter ? stat.orders.filter(function(o) { return o.department === deptFilter; }) : stat.orders;
    var filteredTotal  = filteredOrders.reduce(function(sum, o) { return sum + Number(o.price); }, 0);
    return { restaurantName: stat.restaurantName, orders: filteredOrders, totalAmount: filteredTotal };
  }).filter(function(stat) { return stat.orders.length > 0; });

  if (filtered.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>' + (deptFilter ? '[' + deptFilter + '] ë¶€ì„œì˜ ' : '') + 'ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    return;
  }

  var filterLabel = deptFilter ? ' Â· <span style="color:#667eea;font-size:14px;">ğŸ¢ ' + deptFilter + '</span>' : '';
  var html = '';
  var grand = 0;

  filtered.forEach(function(stat) {
    grand += stat.totalAmount;
    html += '<div class="card" style="background:#f9fafb;">';
    html += '<h3>' + stat.restaurantName + filterLabel + '</h3>';
    html += buildOrderTable(stat.orders);
    html += buildDeptSummaryBox(stat.orders, stat.totalAmount, deptFilter);
    html += '</div>';
  });

  var allOrders = [];
  filtered.forEach(function(s) { allOrders = allOrders.concat(s.orders); });
  html += '<div class="card"><div class="summary-box" style="background:#dcfce7;border-color:#86efac;">';
  html += '<h4>ğŸª ì „ì²´ í•©ê³„' + (deptFilter ? ' (' + deptFilter + ')' : '') + '</h4>';
  filtered.forEach(function(s) {
    html += '<div class="summary-row"><span>' + s.restaurantName + '<span class="summary-count"> (' + s.orders.length + 'ê±´)</span></span><span>' + s.totalAmount.toLocaleString() + 'ì›</span></div>';
  });
  html += '<div class="summary-row total"><span>ì´í•©ê³„ <span class="summary-count">(' + allOrders.length + 'ê±´)</span></span><span>' + grand.toLocaleString() + 'ì›</span></div>';
  html += '</div></div>';
  c.innerHTML = html;
}

function displaySingleRestaurantStats(result) {
  var c = document.getElementById('statsContent');
  var deptFilter = document.getElementById('statsDeptFilter').value;

  if (!result || !result.orders || result.orders.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>í•´ë‹¹ ê¸°ê°„ì— ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }

  var orders = deptFilter ? result.orders.filter(function(o) { return o.department === deptFilter; }) : result.orders;
  var totalAmount = orders.reduce(function(sum, o) { return sum + Number(o.price); }, 0);

  if (orders.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>[' + deptFilter + '] ë¶€ì„œì˜ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }

  var html = '<div class="card">';
  if (deptFilter) html += '<div style="margin-bottom:10px;font-size:14px;color:#667eea;font-weight:600;">ğŸ¢ ' + deptFilter + ' ë¶€ì„œ í•„í„° ì ìš© ì¤‘</div>';
  html += buildOrderTable(orders);
  html += buildDeptSummaryBox(orders, totalAmount, deptFilter);
  html += '</div>';
  c.innerHTML = html;
}

// ============================================
// ë§ˆìŠ¤í„° - íšŒì› ê´€ë¦¬
// ============================================
function toggleRestaurantSelect() {
  var role = document.getElementById('newMemberRole').value;
  var grp  = document.getElementById('memberRestaurantGroup');
  if (role === 'admin') grp.classList.remove('hidden');
  else grp.classList.add('hidden');
}

function loadRestaurantSelectForMember() {
  if (Cache.restaurants) { fillRestaurantSelect('newMemberRestaurant', Cache.restaurants); return; }
  gasCall({ action: 'getRestaurants' })
    .then(function(d) { Cache.restaurants = d; fillRestaurantSelect('newMemberRestaurant', d); });
}

function checkMemberUserId() {
  var userId = document.getElementById('newMemberUserId').value.trim();
  if (!userId) { showAlert('membersAlert', 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  gasCall({ action: 'checkUserId', userId: userId })
    .then(function(r) {
      showAlert('membersAlert', r.message, r.available ? 'success' : 'error');
      memberIdChecked = r.available;
    });
}

function handleAddMember() {
  var userId     = document.getElementById('newMemberUserId').value.trim();
  var password   = document.getElementById('newMemberPassword').value;
  var name       = document.getElementById('newMemberName').value.trim();
  var dept       = document.getElementById('newMemberDept').value;
  var email      = document.getElementById('newMemberEmail').value.trim();
  var role       = document.getElementById('newMemberRole').value;
  var restaurantId = document.getElementById('newMemberRestaurant').value;

  if (!userId || !password || !name || !dept) {
    showAlert('membersAlert', 'ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„, ë¶€ì„œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤', 'error'); return;
  }
  if (!memberIdChecked) { showAlert('membersAlert', 'ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (role === 'admin' && !restaurantId) { showAlert('membersAlert', 'ì‹ë‹¹ ê´€ë¦¬ìëŠ” ë°°ì • ì‹ë‹¹ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤', 'error'); return; }

  showLoading('membersAlert');
  gasPost({ action: 'addMemberByMaster', userId: userId, password: password, name: name, department: dept, email: email, role: role, restaurantId: restaurantId })
    .then(function(r) {
      if (r.success) {
        Cache.clearMembers();
        showAlert('membersAlert', 'íšŒì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        ['newMemberUserId','newMemberPassword','newMemberName','newMemberEmail'].forEach(function(id) { document.getElementById(id).value = ''; });
        document.getElementById('newMemberRole').value = 'user';
        document.getElementById('memberRestaurantGroup').classList.add('hidden');
        memberIdChecked = false;
        loadMembers();
      } else showAlert('membersAlert', r.message, 'error');
    })
    .catch(function() { showAlert('membersAlert', 'íšŒì› ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function renderMembersTable(members) {
  var c = document.getElementById('membersContent');
  if (!members || members.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><p>ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }
  var roleLabel = { master: 'ë§ˆìŠ¤í„°', admin: 'ê´€ë¦¬ì', user: 'ì¼ë°˜' };
  var roleBadge = { master: 'badge-master', admin: 'badge-admin', user: 'badge-user' };
  var rMap = {};
  if (Cache.restaurants) Cache.restaurants.forEach(function(r) { rMap[r.id] = r.name; });

  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-uid"><col class="col-uname"><col class="col-udept"><col class="col-urole"><col class="col-urst"><col class="col-udel"></colgroup>';
  html += '<thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ì—­í• </th><th>ì‹ë‹¹</th><th>ì‚­ì œ</th></tr></thead><tbody>';
  members.forEach(function(m) {
    var rName = m.restaurantId ? (rMap[m.restaurantId] || m.restaurantId) : '-';
    html += '<tr><td>' + m.userId + '</td><td>' + m.name + '</td><td>' + m.department + '</td>';
    html += '<td><span class="member-role-badge ' + (roleBadge[m.role] || 'badge-user') + '">' + (roleLabel[m.role] || m.role) + '</span></td>';
    html += '<td style="font-size:11px;color:#6b7280;">' + rName + '</td>';
    html += '<td>' + (m.role === 'master' ? '-' : '<button class="btn btn-danger btn-small" onclick="deleteMember(\'' + m.userId + '\',\'' + escStr(m.name) + '\')">ì‚­ì œ</button>') + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  html += '<p style="margin-top:10px;font-size:13px;color:#6b7280;text-align:right;">ì´ ' + members.length + 'ëª…</p>';
  c.innerHTML = html;
}

function loadMembers() {
  if (Cache.members) { renderMembersTable(Cache.members); return; }
  document.getElementById('membersContent').innerHTML = loadingHtml();
  gasCall({ action: 'getMembers' })
    .then(function(d) { Cache.members = d; renderMembersTable(d); })
    .catch(function() { document.getElementById('membersContent').innerHTML = errorHtml('íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
}

function deleteMember(userId, name) {
  if (!confirm(name + 'ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  gasPost({ action: 'deleteMember', userId: userId })
    .then(function(r) {
      if (r.success) { Cache.clearMembers(); showAlert('membersAlert', 'íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); loadMembers(); }
      else showAlert('membersAlert', r.message, 'error');
    })
    .catch(function() { showAlert('membersAlert', 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ë¶€ì„œ ê´€ë¦¬
// ============================================
function loadDeptSelect(selectId) {
  var sel = document.getElementById(selectId);
  if (!sel) return;
  if (Cache.departments) { fillDeptSelect(selectId, Cache.departments); return; }
  sel.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
  gasCall({ action: 'getDepartments' })
    .then(function(depts) { Cache.departments = depts; fillDeptSelect(selectId, depts); })
    .catch(function() { sel.innerHTML = '<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>'; });
}

function fillDeptSelect(selectId, depts) {
  var sel = document.getElementById(selectId);
  if (!sel) return;
  sel.innerHTML = '<option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
  depts.forEach(function(d) {
    var opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    sel.appendChild(opt);
  });
}

function loadDepartmentsForMaster() {
  if (Cache.departments) { renderDeptTable(Cache.departments); return; }
  document.getElementById('deptsContent').innerHTML = loadingHtml();
  gasCall({ action: 'getDepartments' })
    .then(function(depts) {
      Cache.departments = depts;
      renderDeptTable(depts);
      fillDeptSelect('newMemberDept', depts);
      fillDeptSelect('registerDepartment', depts);
    })
    .catch(function() { document.getElementById('deptsContent').innerHTML = errorHtml('ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
}

function renderDeptTable(depts) {
  var c = document.getElementById('deptsContent');
  if (!depts || depts.length === 0) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¢</div><p>ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>'; return;
  }
  var html = '<div class="table-wrap"><table>';
  html += '<colgroup><col class="col-dname"><col class="col-ddel"></colgroup>';
  html += '<thead><tr><th>ë¶€ì„œ ì´ë¦„</th><th>ì‚­ì œ</th></tr></thead><tbody>';
  depts.forEach(function(d) {
    html += '<tr><td>' + d + '</td>';
    html += '<td><button class="btn btn-danger btn-small" onclick="handleDeleteDepartment(\'' + d.replace(/\\/g,'\\\\').replace(/'/g,"\\'") + '\')">ì‚­ì œ</button></td></tr>';
  });
  html += '</tbody></table></div>';
  c.innerHTML = html;
}

function handleAddDepartment() {
  var name = document.getElementById('newDeptName').value.trim();
  if (!name) { showAlert('deptAlert', 'ë¶€ì„œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  gasPost({ action: 'addDepartment', name: name })
    .then(function(r) {
      if (r.success) {
        document.getElementById('newDeptName').value = '';
        refreshDeptCache(function() { showAlert('deptAlert', 'ë¶€ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); });
      } else { showAlert('deptAlert', r.message, 'error'); }
    })
    .catch(function() { showAlert('deptAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function handleDeleteDepartment(name) {
  if (!confirm(name + ' ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  gasPost({ action: 'deleteDepartment', name: name })
    .then(function(r) {
      if (r.success) {
        refreshDeptCache(function() { showAlert('deptAlert', 'ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); });
      } else { showAlert('deptAlert', r.message, 'error'); }
    })
    .catch(function() { showAlert('deptAlert', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

function refreshDeptCache(callback) {
  gasCall({ action: 'getDepartments' })
    .then(function(depts) {
      Cache.departments = depts;
      renderDeptTable(depts);
      fillDeptSelect('newMemberDept', depts);
      fillDeptSelect('registerDepartment', depts);
      if (callback) callback();
    })
    .catch(function() { showAlert('deptAlert', 'ëª©ë¡ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); });
}

// ============================================
// ìœ í‹¸ë¦¬í‹°
// ============================================
function showAlert(containerId, message, type) {
  var c = document.getElementById(containerId);
  if (!c) return;
  var cls = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
  c.innerHTML = '<div class="alert ' + cls + '">' + message + '</div>';
  setTimeout(function() { if (c) c.innerHTML = ''; }, 5000);
}

function showLoading(containerId) {
  var c = document.getElementById(containerId);
  if (c) c.innerHTML = '<div class="alert alert-info"><div style="display:inline-block;width:16px;height:16px;border:2px solid #3b82f6;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;margin-right:10px;vertical-align:middle;"></div>ì²˜ë¦¬ ì¤‘...</div>';
}

function loadingHtml() { return '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>'; }
function errorHtml(msg) { return '<div class="alert alert-error">' + msg + '</div>'; }
</script>
</body>
</html>
